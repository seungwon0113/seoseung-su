{% extends "base.html" %}
{% load static %}
{% load product_filters %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/products/detail.css' %}">
<link rel="stylesheet" href="{% static 'css/products/product-description-or-review.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="products-detail">
        <div class="product-images">
            {% if products.image.all %}
                <div class="main-image">
                    <img src="{{ products.image.first.image.url }}" alt="{{ products.name }}" id="mainImage">
                </div>
                {% if products.image.count > 1 %}
                <div class="thumbnail-images">
                    {% for image in products.image.all %}
                    <img src="{{ image.image.url }}" alt="{{ products.name }}" class="thumbnail" onclick="changeMainImage('{{ image.image.url }}')">
                    {% endfor %}
                </div>
                {% endif %}
            {% else %}
                <div class="no-image">
                    <span>ì´ë¯¸ì§€ ì—†ìŒ</span>
                </div>
            {% endif %}
        </div>
        
        <div class="product-info">
            <h1 class="product-name">{{ products.name }}</h1>
            <p class="product-description">{{ products.description }}</p>
            
            <div class="price-section">
                {% if products.sale_price %}
                    <div class="price-row">
                        <span class="sale-price">{{ products.price|discount_amount:products.sale_price }}ì›</span>
                        <span class="original-price">{{ products.price|floatformat:0 }}ì›</span>
                        <span class="discount-rate">{{ products.sale_price|floatformat:0 }}ì› í• ì¸</span>
                    </div>
                {% else %}
                    <div class="price-row">
                        <span class="price">{{ products.price|floatformat:0 }}ì›</span>
                    </div>
                {% endif %}
            </div>
            
            <div class="shipping-info">
                <div class="shipping-item">
                    <span class="shipping-label">êµ­ë‚´Â·í•´ì™¸ë°°ì†¡:</span>
                    <span class="shipping-value">êµ­ë‚´ë°°ì†¡</span>
                </div>
                <div class="shipping-item">
                    <span class="shipping-label">ë°°ì†¡ë°©ë²•:</span>
                    <span class="shipping-value">íƒë°°</span>
                </div>
                <div class="shipping-item">
                    <span class="shipping-label">ë°°ì†¡ë¹„:</span>
                    <span class="shipping-value">3,000ì›(50,000ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œ)</span>
                </div>
            </div>
            
            <div class="product-actions">
                {% if products.is_live and not products.is_sold %}
                    <div class="primary-action">
                        <button class="btn btn-primary btn-large">ì¦‰ì‹œ êµ¬ë§¤</button>
                    </div>
                    <div class="secondary-actions">
                        <button class="btn btn-secondary btn-large">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                        <button class="btn btn-thirdly btn-large">ì°œí•˜ê¸°</button>
                    </div>
                {% else %}
                    <button class="btn btn-disabled btn-large" disabled>
                        {% if products.is_sold %}í’ˆì ˆ{% else %}íŒë§¤ ì¤€ë¹„ì¤‘{% endif %}
                    </button>
                {% endif %}
            </div>

        </div>
    </div>
    <div class="product-description-or-review-container">
        <div class="product-description-or-review-toggle">
            <button class="tab-button active" data-tab="description">ìƒí’ˆ ìƒì„¸ë‚´ìš©</button>
            <button class="tab-button" data-tab="review">ë¦¬ë·°</button>
            <button class="tab-button" data-tab="ai-agent">AI ì—ì´ì „íŠ¸</button>
        </div>
        
        <div class="tab-content">
            <div class="tab-panel active" id="description">
                <div class="product-detail-content">
                    <h3>ìƒí’ˆ ìƒì„¸ ì •ë³´</h3>
                    <div class="detail-info">
                        <div class="info-item">
                            <span class="info-label">ìƒí’ˆëª…:</span>
                            <span class="info-value">{{ products.name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ìƒí’ˆ ì„¤ëª…:</span>
                            <span class="info-value">{{ products.description }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ê°€ê²©:</span>
                            <span class="info-value">{{ products.price|floatformat:0 }}ì›</span>
                        </div>
                        {% if products.sale_price %}
                        <div class="info-item">
                            <span class="info-label">í• ì¸ê°€:</span>
                            <span class="info-value">{{ products.sale_price|floatformat:0 }}ì›</span>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <span class="info-label">ì¬ê³ :</span>
                            <span class="info-value">{{ products.stock }}ê°œ</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ì¹´í…Œê³ ë¦¬:</span>
                            <span class="info-value">
                                {% for category in products.categories.all %}
                                    {{ category.name }}{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    ì¹´í…Œê³ ë¦¬ ì—†ìŒ
                                {% endfor %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" id="review">
                <div class="review-content-detail">
                    <h3>ìƒí’ˆ ë¦¬ë·°</h3>
                </div>
                <div class="review-content">

                    <div class="review-summary">
                        <div class="rating-summary">
                            <span class="rating-label">í‰ì :</span>
                            <span class="rating-value">
                                {% if avg_rating > 0 %}
                                    {% with ''|center:5 as range %}
                                        {% for i in range %}
                                            {% if forloop.counter <= avg_rating|floatformat:0 %}â˜…{% else %}â˜†{% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                    ({{ avg_rating|floatformat:1 }}/5)
                                {% else %}
                                    â˜†â˜†â˜†â˜†â˜† (í‰ì  ì—†ìŒ)
                                {% endif %}
                            </span>
                        </div>
                        <div class="review-count">
                            <span>ì´ {{ review_count }}ê°œì˜ ë¦¬ë·°</span>
                        </div>
                    </div>
                    
                    <!-- ë¦¬ë·° ì‘ì„± í¼ -->
                    {% if user.is_authenticated and not user_review %}
                    <div class="review-write-section">
                        <h3>ë¦¬ë·° ì‘ì„±í•˜ê¸°</h3>
                        <form method="post" action="{% url 'review-create' products.id %}" enctype="multipart/form-data" class="review-form">
                            {% csrf_token %}
                            
                            <div class="form-group">
                                <label for="id_rating">{{ review_form.rating.label }}</label>
                                <div class="rating-select">
                                    <input type="radio" id="rating-5" name="rating" value="5" checked>
                                    <label for="rating-5">â˜…</label>
                                    <input type="radio" id="rating-4" name="rating" value="4">
                                    <label for="rating-4">â˜…</label>
                                    <input type="radio" id="rating-3" name="rating" value="3">
                                    <label for="rating-3">â˜…</label>
                                    <input type="radio" id="rating-2" name="rating" value="2">
                                    <label for="rating-2">â˜…</label>
                                    <input type="radio" id="rating-1" name="rating" value="1">
                                    <label for="rating-1">â˜…</label>
                                </div>
                                {% if review_form.rating.errors %}
                                    <div class="error-message">{{ review_form.rating.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_content">{{ review_form.content.label }}</label>
                                {{ review_form.content }}
                                {% if review_form.content.errors %}
                                    <div class="error-message">{{ review_form.content.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_image">{{ review_image_form.image.label }} (ì„ íƒì‚¬í•­)</label>
                                {{ review_image_form.image }}
                                <small class="form-hint">ìµœëŒ€ 5ê°œì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                                {% if review_image_form.image.errors %}
                                    <div class="error-message">{{ review_image_form.image.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">ë¦¬ë·° ë“±ë¡</button>
                            </div>
                        </form>
                    </div>
                    {% elif not user.is_authenticated %}
                    <div class="review-login-required">
                        <p>ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">ë¡œê·¸ì¸í•˜ê¸°</a>
                    </div>
                    {% endif %}
                    
                    <div class="review-list">
                        {% for review in reviews %}
                        <div class="review-item" id="review-{{ review.id }}">
                            <div class="review-header">
                                <span class="reviewer-name">{{ review.get_masked_username }}</span>
                                <span class="review-rating">{{ review.get_star_display }}</span>
                                <span class="review-date">{{ review.created_at|date:"Y.m.d" }}</span>
                                {% if user == review.user %}
                                <div class="review-actions">
                                    <a href="{% url 'review-update' review.id %}" class="btn-edit">ìˆ˜ì •</a>
                                    <form method="post" action="{% url 'review-delete' review.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-delete" onclick="return confirm('ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="review-text">
                                {{ review.content }}
                            </div>
                            
                            {% if review.images.all %}
                            <div class="review-images">
                                {% for image in review.images.all %}
                                <img src="{{ image.image.url }}" alt="ë¦¬ë·° ì´ë¯¸ì§€" class="review-image">
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- ê´€ë¦¬ì ë‹µê¸€ ì„¹ì…˜ -->
                            {% if review.comments.all or user.role == 'admin' %}
                            <div class="review-comments">
                                {% for comment in review.comments.all %}
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <span class="comment-author admin-badge">{{ comment.user.username }}</span>
                                        <span class="comment-date">{{ comment.created_at|date:"Y.m.d H:i" }}</span>
                                        {% if user.role == 'admin' %}
                                        <form method="post" action="{% url 'review-comment-delete' comment.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-comment-delete" onclick="return confirm('ë‹µê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    <div class="comment-content">
                                        {% if comment.is_published %}
                                            {{ comment.content }}
                                        {% elif user.role == 'admin' or user == review.user %}
                                            {{ comment.content }}
                                        {% else %}
                                            <span class="private-comment">ë¹„ê³µê°œ ë‹µê¸€ì…ë‹ˆë‹¤</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if user.role == 'admin' %}
                                <div class="admin-comment-form">
                                    <h5>ê´€ë¦¬ì ë‹µê¸€ ì‘ì„±</h5>
                                    <form method="post" action="{% url 'review-comment-create' review.id %}" class="comment-form">
                                        {% csrf_token %}
                                        <div class="comment-input-wrapper">
                                            {{ comment_form.content }}
                                            <div class="comment-options">
                                                <label class="public-checkbox-label">
                                                    {{ comment_form.is_published }}
                                                    <span class="checkbox-text">ê³µê°œ ë‹µê¸€</span>
                                                </label>
                                                <div class="char-counter">
                                                    <span class="char-count">0</span>/500
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn-admin-comment">ë‹µê¸€ ì‘ì„±</button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" id="ai-agent">
                <div class="ai-agent-content">
                    <h3>AI ê°€ìƒ í”¼íŒ…</h3>
                    <div class="ai-chat">
                        <div class="ai-message">
                            <div class="ai-avatar">SSS</div>
                            <div class="ai-text">
                                ì•ˆë…•í•˜ì„¸ìš”! AI ê°€ìƒ í”¼íŒ… ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. 
                                ì…€ì¹´ë‚˜ ì „ì‹  ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì‹œë©´ ì´ ìƒí’ˆì„ ì…ì–´ë³´ì‹  ëª¨ìŠµì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                ì „ì‹ ì´ ì˜ ë‚˜ì˜¨ ì‚¬ì§„ì¼ìˆ˜ë¡ ë” ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”!
                            </div>
                        </div>
                    </div>
                    
                    <div class="photo-upload-area">
                        <div class="upload-section">
                            <div class="upload-box" id="uploadBox">
                                <div class="upload-icon">ğŸ“·</div>
                                <div class="upload-text">
                                    <h4>ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h4>
                                    <p>ì…€ì¹´ë‚˜ ì „ì‹  ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                                    <p class="upload-hint">JPG, PNG íŒŒì¼ë§Œ ì§€ì› (ìµœëŒ€ 10MB)</p>
                                </div>
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <div class="uploaded-photo" id="uploadedPhoto" style="display: none;">
                                <div class="photo-preview">
                                    <img id="previewImage" src="" alt="ì—…ë¡œë“œëœ ì‚¬ì§„">
                                    <button class="remove-photo" id="removePhoto">Ã—</button>
                                </div>
                                <div class="photo-info">
                                    <p class="photo-name" id="photoName"></p>
                                    <p class="photo-size" id="photoSize"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ai-process-section" id="aiProcessSection" style="display: none;">
                            <button class="ai-process-btn" id="aiProcessBtn">
                                <span class="btn-icon">âœ¨</span>
                                <span class="btn-text">AI ê°€ìƒ í”¼íŒ… ì‹œì‘</span>
                            </button>
                            <p class="process-hint">AIê°€ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ ê°€ìƒ í”¼íŒ…ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>
                        </div>
                        
                        <div class="ai-result-section" id="aiResultSection" style="display: none;">
                            <h4>ê°€ìƒ í”¼íŒ… ê²°ê³¼</h4>
                            <div class="result-images">
                                <div class="result-item">
                                    <h5>ì›ë³¸ ì‚¬ì§„</h5>
                                    <img id="originalResult" src="" alt="ì›ë³¸ ì‚¬ì§„">
                                </div>
                                <div class="result-item">
                                    <h5>ê°€ìƒ í”¼íŒ… ê²°ê³¼</h5>
                                    <img id="fittingResult" src="" alt="ê°€ìƒ í”¼íŒ… ê²°ê³¼">
                                </div>
                            </div>
                            <div class="result-actions">
                                <button class="download-btn">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                                <button class="retry-btn">ë‹¤ì‹œ ì‹œë„</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/products/product-description-or-review.js' %}"></script>
<script src="{% static 'js/products/detail.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('.comment-input-wrapper textarea');
    
    textareas.forEach(function(textarea) {
        const charCount = textarea.parentElement.querySelector('.char-count');
        
        if (charCount) {
            function updateCharCount() {
                const count = textarea.value.length;
                charCount.textContent = count;
                
                // ê¸€ììˆ˜ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                if (count > 450) {
                    charCount.style.color = '#ef4444';
                } else if (count > 400) {
                    charCount.style.color = '#f59e0b';
                } else {
                    charCount.style.color = '#374151';
                }
            }
            
            textarea.addEventListener('input', updateCharCount);
            updateCharCount(); // ì´ˆê¸° ì¹´ìš´íŠ¸ ì„¤ì •
        }
    });
});
</script>
{% endblock %}
