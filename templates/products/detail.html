{% extends "base.html" %}
{% load static %}
{% load product_filters %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/products/detail.css' %}">
<link rel="stylesheet" href="{% static 'css/products/product_description.css' %}">
<link rel="stylesheet" href="{% static 'css/products/review.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="products-detail">
        <div class="product-images">
            {% if products.image.all %}
                <div class="main-image">
                    <img src="{{ products.image.first.image.url }}" alt="{{ products.name }}" id="mainImage">
                </div>
                {% if products.image.count > 1 %}
                <div class="thumbnail-images">
                    {% for image in products.image.all %}
                    <img src="{{ image.image.url }}" alt="{{ products.name }}" class="thumbnail" onclick="changeMainImage('{{ image.image.url }}')">
                    {% endfor %}
                </div>
                {% endif %}
            {% else %}
                <div class="no-image">
                    <span>이미지 없음</span>
                </div>
            {% endif %}
        </div>
        
        <div class="product-info">
            <h1 class="product-name">{{ products.name }}</h1>
            <p class="product-description">{{ products.description }}</p>
            
            <div class="price-section">
                {% if products.sale_price %}
                    <div class="price-row">
                        <span class="sale-price">{{ products.price|discount_amount:products.sale_price }}원</span>
                        <span class="original-price">{{ products.price|floatformat:0 }}원</span>
                        <span class="discount-rate">{{ products.sale_price|floatformat:0 }}원 할인</span>
                    </div>
                {% else %}
                    <div class="price-row">
                        <span class="price">{{ products.price|floatformat:0 }}원</span>
                    </div>
                {% endif %}
            </div>
            
            <div class="size-quantity-section" data-product-stock="{{ products.stock }}">
                <div class="size-selection">
                    <div class="size-options">
                        <button class="size-btn" data-size="S">S</button>
                        <button class="size-btn" data-size="M">M</button>
                        <button class="size-btn" data-size="L">L</button>
                    </div>
                </div>
                <div class="quantity-selection">
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                        <span class="quantity-display" id="quantityDisplay">1</span>
                        <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                    </div>
                </div>
            </div>
            
            <div class="product-actions">
                {% if products.is_live and not products.is_sold %}
                    <div class="primary-action">
                        <button class="btn btn-primary btn-large">즉시 구매</button>
                    </div>
                    <div class="secondary-actions">
                        {% if user.is_authenticated %}
                            <form method="post" action="{% url 'cart-create' %}" class="cart-form">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ products.id }}">
                                <input type="hidden" name="quantity" id="cartQuantity" value="1">
                                <button type="submit" class="btn btn-secondary">장바구니 담기</button>
                            </form>
                        {% else %}
                            <button class="btn btn-secondary" onclick="alert('로그인이 필요합니다.')">장바구니 담기</button>
                        {% endif %}

                        <form class="wishlist-form">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ products.id }}">
                            <button type="submit" class="btn btn-secondary">찜하기</button>
                        </form>
                    </div>
                {% else %}
                    <button class="btn btn-disabled btn-large" disabled>
                        {% if products.is_sold %}품절{% else %}판매 준비중{% endif %}
                    </button>
                {% endif %}
            </div>

            <div class="shipping-info">
                <div class="shipping-item">
                    <span class="shipping-label">국내·해외배송:</span>
                    <span class="shipping-value">국내배송</span>
                </div>
                <div class="shipping-item">
                    <span class="shipping-label">배송방법:</span>
                    <span class="shipping-value">택배</span>
                </div>
                <div class="shipping-item">
                    <span class="shipping-label">배송비:</span>
                    <span class="shipping-value">3,000원(50,000원 이상 구매 시 무료)</span>
                </div>
            </div>

        </div>
    </div>
    <div class="product-description-or-review-container">
        <div class="product-description-or-review-toggle">
            <button class="tab-button active" data-tab="description">상품 상세내용</button>
            <button class="tab-button" data-tab="review">리뷰</button>
            <button class="tab-button" data-tab="ai-agent">AI 에이전트</button>
        </div>
        
        <div class="tab-content">
            <div class="tab-panel active" id="description">
                <div class="product-detail-content">
                    <h3>상품 상세 정보</h3>
                    <div class="detail-info">
                        <div class="info-item">
                            <span class="info-label">상품명:</span>
                            <span class="info-value">{{ products.name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">상품 설명:</span>
                            <span class="info-value">{{ products.description }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">가격:</span>
                            <span class="info-value">{{ products.price|floatformat:0 }}원</span>
                        </div>
                        {% if products.sale_price %}
                        <div class="info-item">
                            <span class="info-label">할인가:</span>
                            <span class="info-value">{{ products.sale_price|floatformat:0 }}원</span>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <span class="info-label">재고:</span>
                            <span class="info-value">{{ products.stock }}개</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">카테고리:</span>
                            <span class="info-value">
                                {% for category in products.categories.all %}
                                    {{ category.name }}{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    카테고리 없음
                                {% endfor %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" id="review">
                <div class="review-content-detail">
                    <h3>상품 리뷰</h3>
                </div>
                <div class="review-content">

                    <div class="review-summary">
                        <div class="rating-summary">
                            <span class="rating-label">평점:</span>
                            <div class="rating-value">
                                {% if avg_rating > 0 %}
                                    <div class="star-rating" data-rating="{{ avg_rating|floatformat:1 }}">
                                        <span class="stars-background">★★★★★</span>
                                        <span class="stars-fill">★★★★★</span>
                                    </div>
                                    <span class="rating-text">({{ avg_rating|floatformat:1 }}/5)</span>
                                {% else %}
                                    <div class="star-rating" data-rating="0">
                                        <span class="stars-background">☆☆☆☆☆</span>
                                        <span class="stars-fill">★★★★★</span>
                                    </div>
                                    <span class="rating-text">(평점 없음)</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="review-count">
                            <span>총 {{ review_count }}개의 리뷰</span>
                        </div>
                    </div>
                    
                    {% if user.is_authenticated and not user_review %}
                    <div class="review-write-section">
                        <h3>리뷰 작성하기</h3>
                        <form method="post" action="{% url 'review-create' products.id %}" enctype="multipart/form-data" class="review-form">
                            {% csrf_token %}
                            
                            <div class="form-group">
                                <label for="id_rating">{{ review_form.rating.label }}</label>
                                <div class="rating-select">
                                    <input type="radio" id="rating-5" name="rating" value="5" checked>
                                    <label for="rating-5">★</label>
                                    <input type="radio" id="rating-4" name="rating" value="4">
                                    <label for="rating-4">★</label>
                                    <input type="radio" id="rating-3" name="rating" value="3">
                                    <label for="rating-3">★</label>
                                    <input type="radio" id="rating-2" name="rating" value="2">
                                    <label for="rating-2">★</label>
                                    <input type="radio" id="rating-1" name="rating" value="1">
                                    <label for="rating-1">★</label>
                                </div>
                                {% if review_form.rating.errors %}
                                    <div class="error-message">{{ review_form.rating.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_content">{{ review_form.content.label }}</label>
                                {{ review_form.content }}
                                {% if review_form.content.errors %}
                                    <div class="error-message">{{ review_form.content.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_image">{{ review_image_form.image.label }} (선택사항)</label>
                                {{ review_image_form.image }}
                                <small class="form-hint">최대 5개의 이미지를 업로드할 수 있습니다.</small>
                                {% if review_image_form.image.errors %}
                                    <div class="error-message">{{ review_image_form.image.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">리뷰 등록</button>
                            </div>
                        </form>
                    </div>
                    {% elif not user.is_authenticated %}
                    {% endif %}
                    
                    <div class="review-list">
                        {% for review in reviews %}
                        <div class="review-item" id="review-{{ review.id }}">
                            <div class="review-header">
                                <div class="review-header-top">
                                    <span class="reviewer-name">{{ review.get_masked_username }}</span>
                                    <span class="review-rating" id="review-rating-{{ review.id }}">{{ review.get_star_display }}</span>
                                    <span class="review-date">{{ review.created_at|date:"Y.m.d" }}</span>
                                </div>
                                {% if user == review.user %}
                                <div class="review-actions">
                                    <button class="btn-review-edit" onclick="editReview({{ review.id }})">수정</button>
                                    <form method="post" action="{% url 'review-delete' review.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-review-delete" onclick="return confirm('리뷰를 삭제하시겠습니까?')">삭제</button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% if review.images.all %}
                            <div class="review-images">
                                {% for image in review.images.all %}
                                <img src="{{ image.image.url }}" alt="리뷰 이미지" class="review-image">
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="review-text" id="review-text-{{ review.id }}" data-content="{{ review.content }}" data-rating="{{ review.rating }}">
                                {{ review.content }}
                            </div>

                            <div class="review-edit-form" id="review-edit-form-{{ review.id }}" style="display: none;">
                                <div class="review-edit-rating">
                                    <div class="rating-select-edit" id="rating-edit-{{ review.id }}">
                                        <input type="radio" id="rating-edit-5-{{ review.id }}" name="rating-edit-{{ review.id }}" value="5" {% if review.rating == 5 %}checked{% endif %}>
                                        <label for="rating-edit-5-{{ review.id }}">★</label>
                                        <input type="radio" id="rating-edit-4-{{ review.id }}" name="rating-edit-{{ review.id }}" value="4" {% if review.rating == 4 %}checked{% endif %}>
                                        <label for="rating-edit-4-{{ review.id }}">★</label>
                                        <input type="radio" id="rating-edit-3-{{ review.id }}" name="rating-edit-{{ review.id }}" value="3" {% if review.rating == 3 %}checked{% endif %}>
                                        <label for="rating-edit-3-{{ review.id }}">★</label>
                                        <input type="radio" id="rating-edit-2-{{ review.id }}" name="rating-edit-{{ review.id }}" value="2" {% if review.rating == 2 %}checked{% endif %}>
                                        <label for="rating-edit-2-{{ review.id }}">★</label>
                                        <input type="radio" id="rating-edit-1-{{ review.id }}" name="rating-edit-{{ review.id }}" value="1" {% if review.rating == 1 %}checked{% endif %}>
                                        <label for="rating-edit-1-{{ review.id }}">★</label>
                                    </div>
                                </div>
                                <textarea class="review-edit-textarea" id="review-edit-textarea-{{ review.id }}" maxlength="1000" rows="5">{{ review.content }}</textarea>
                                <div class="review-edit-options">
                                    <div class="char-counter">
                                        <span class="char-count" id="review-edit-char-count-{{ review.id }}">{{ review.content|length }}</span>/1000
                                    </div>
                                </div>
                                <div class="review-edit-buttons">
                                    <button class="btn-review-save" onclick="saveReview({{ review.id }})">저장</button>
                                    <button class="btn-review-cancel" onclick="cancelEditReview({{ review.id }})">취소</button>
                                </div>
                            </div>
                            
                            
                            {% if review.comments.all or user.role == 'admin' %}
                            <div class="review-comments">
                                {% for comment in review.comments.all %}
                                <div class="comment-item" id="comment-{{ comment.id }}">
                                    <div class="comment-header">
                                        <div class="comment-header-top">
                                            <span class="comment-author admin-badge">{{ comment.user.username }}</span>
                                            <span class="comment-date">{{ comment.created_at|date:"Y.m.d H:i" }}</span>
                                        </div>
                                        {% if user.role == 'admin' %}
                                        <div class="comment-actions">
                                            <button class="btn-comment-edit" onclick="editComment({{ comment.id }})">수정</button>
                                            <form method="post" action="{% url 'review-comment-delete' comment.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn-comment-delete" onclick="return confirm('답글을 삭제하시겠습니까?')">삭제</button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="comment-content" data-comment-id="{{ comment.id }}" data-content="{{ comment.content }}" data-is-published="{{ comment.is_published|yesno:'true,false' }}">
                                        {% if comment.is_published %}
                                            {{ comment.content }}
                                        {% elif user.role == 'admin' or user == review.user %}
                                            {{ comment.content }}
                                        {% else %}
                                            <span class="private-comment">비공개 답글입니다</span>
                                        {% endif %}
                                    </div>
                                    <div class="comment-edit-form" id="edit-form-{{ comment.id }}" style="display: none;">
                                        <textarea class="comment-edit-textarea" id="edit-textarea-{{ comment.id }}" maxlength="500">{{ comment.content }}</textarea>
                                        <div class="comment-edit-options">
                                            <label class="edit-public-checkbox-label">
                                                <input type="checkbox" id="edit-is-published-{{ comment.id }}" {% if comment.is_published %}checked{% endif %}>
                                                <span class="checkbox-text">공개 답글</span>
                                            </label>
                                            <div class="char-counter">
                                                <span class="char-count" id="edit-char-count-{{ comment.id }}">{{ comment.content|length }}</span>/500
                                            </div>
                                        </div>
                                        <div class="comment-edit-buttons">
                                            <button class="btn-comment-save" onclick="saveComment({{ comment.id }})">저장</button>
                                            <button class="btn-comment-cancel" onclick="cancelEditComment({{ comment.id }})">취소</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if user.role == 'admin' %}
                                <div class="admin-comment-form">
                                    <h5>관리자 답글 작성</h5>
                                    <form method="post" action="{% url 'review-comment-create' review.id %}" class="comment-form">
                                        {% csrf_token %}
                                        <div class="comment-input-wrapper">
                                            {{ comment_form.content }}
                                            <div class="comment-options">
                                                <label class="public-checkbox-label">
                                                    {{ comment_form.is_published }}
                                                    <span class="checkbox-text">공개 답글</span>
                                                </label>
                                                <div class="char-counter">
                                                    <span class="char-count">0</span>/500
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn-admin-comment">답글 작성</button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" id="ai-agent">
                <div class="ai-agent-content">
                    <h3>AI 가상 피팅</h3>
                    <div class="ai-chat">
                        <div class="ai-message">
                            <div class="ai-avatar">SSS</div>
                            <div class="ai-text">
                                안녕하세요! AI 가상 피팅 서비스입니다. 
                                셀카나 전신 사진을 업로드하시면 이 상품을 입어보신 모습을 확인하실 수 있습니다.
                                전신이 잘 나온 사진일수록 더 정확한 결과를 얻을 수 있어요!
                            </div>
                        </div>
                    </div>
                    
                    <div class="photo-upload-area">
                        <div class="upload-section">
                            <div class="upload-box" id="uploadBox">
                                <div class="upload-icon">📷</div>
                                <div class="upload-text">
                                    <h4>사진을 업로드해주세요</h4>
                                    <p>셀카나 전신 사진을 드래그하거나 클릭하여 업로드</p>
                                    <p class="upload-hint">JPG, PNG 파일만 지원 (최대 10MB)</p>
                                </div>
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <div class="uploaded-photo" id="uploadedPhoto" style="display: none;">
                                <div class="photo-preview">
                                    <img id="previewImage" src="" alt="업로드된 사진">
                                    <button class="remove-photo" id="removePhoto">×</button>
                                </div>
                                <div class="photo-info">
                                    <p class="photo-name" id="photoName"></p>
                                    <p class="photo-size" id="photoSize"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ai-process-section" id="aiProcessSection" style="display: none;">
                            <button class="ai-process-btn" id="aiProcessBtn">
                                <span class="btn-icon">✨</span>
                                <span class="btn-text">AI 가상 피팅 시작</span>
                            </button>
                            <p class="process-hint">AI가 사진을 분석하여 가상 피팅을 진행합니다.</p>
                        </div>
                        
                        <div class="ai-result-section" id="aiResultSection" style="display: none;">
                            <h4>가상 피팅 결과</h4>
                            <div class="result-images">
                                <div class="result-item">
                                    <h5>원본 사진</h5>
                                    <img id="originalResult" src="" alt="원본 사진">
                                </div>
                                <div class="result-item">
                                    <h5>가상 피팅 결과</h5>
                                    <img id="fittingResult" src="" alt="가상 피팅 결과">
                                </div>
                            </div>
                            <div class="result-actions">
                                <button class="download-btn">결과 다운로드</button>
                                <button class="retry-btn">다시 시도</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/products/product-description-or-review.js' %}"></script>
<script src="{% static 'js/products/detail.js' %}"></script>
<script src="{% static 'js/products/review_rating.js' %}"></script>
<script src="{% static 'js/products/size_quantity.js' %}"></script>
{% endblock %}
